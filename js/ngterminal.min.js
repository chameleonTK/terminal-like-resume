angular.module("ngterminal",[]),angular.module("ngterminal").factory("Command",["$q",function(e){function n(e,n){if(n.length>0){if(n[0].length>0&&"-"==n[0][0])var t=n[0].split("").find(function(e){return"a"==e}),i=n[0].split("").find(function(e){return"l"==e});var s=n.find(function(e){return e.length>0&&"-"!=e[0]});if(s){if(console.log(s,n[n.length-1]),s!=n[n.length-1])return{successful:!1,messages:["ls: Not support list multiple files"]};return r.find(function(e){return"folder"==e.type&&e.name==s})?{successful:!0,messages:[]}:{successful:!1,messages:["ls: "+s+": No such file or directory"]}}}if(i){var u=r.reduce(function(e,n){for(var t=n.size;t.length<6;)t=" "+t;return"folder"==n.type?e.push("drw-r--r--   1 imtk  imtk       "+t+" Mar 10 00:00 "+n.name):e.push("-rw-r--r--   1 imtk  imtk       "+t+" Mar 10 00:00 "+n.name),e},[]);return{successful:!0,messages:u}}if(t){var u=r.reduce(function(e,n){return e.push(n.name),e},[]);return{successful:!0,messages:u}}var o=Math.ceil(r.length/2),u=r.reduce(function(e,n,t){if(t<o)e.push(n.name);else{for(;e[t-o].length<14;)e[t-o]+=" ";e[t-o]+=n.name}return e},[]);return{successful:!0,messages:u}}function t(t,r){return e(function(e,i){switch(t){case"ls":return e(n(t,r)),!0;default:return e({successful:!1,messages:["-bash: "+t+": command not found"]}),!1}})}var r=[{name:"blog",type:"folder",size:"29k"},{name:"contact.txt",type:"file",size:"32"},{name:"profile.txt",type:"file",size:"2"},{name:"twitter",type:"folder",size:"430"},{name:"README.md",type:"file",size:"3723"}];return{execute:t}}]),angular.module("ngterminal").directive("terminal",["$sce","$q","$interval","$document","$timeout","$location","$anchorScroll","Command",function(e,n,t,r,i,s,u,o){var a=this;return{scope:{},templateUrl:"templates/terminal.html",link:function(c){function l(){return a.options.terminal_name+":~$ "}function m(){c.plainText.push(""),c.lines.push(""),a.currentIndex++,x(a.currentIndex)}function f(e){e.reduce(function(e,n){return e.then(function(){return d(n)})},n.resolve()).then(function(){return d(l(),!0)})}function d(e,r){return a.typerAviable=!1,n(function(n,i){var s=0;t(function(){s>=e.length?(r||m(),a.typerAviable=!0,n()):p(e[s]),s++},a.options.write_delay,e.length+1)})}function p(n){c.plainText[a.currentIndex]+=g(n),c.lines[a.currentIndex]=e.trustAsHtml(c.plainText[a.currentIndex])}function h(n){var t=c.plainText[a.currentIndex];if(!n&&t.length<=a.options.terminal_name.length+9)return!1;if(";"==t[t.length-1]){for(;"&"!=t[t.length-1];)t=t.slice(0,-1),c.plainText[a.currentIndex]=t,c.lines[a.currentIndex]=e.trustAsHtml(t);c.plainText[a.currentIndex]=t.slice(0,-1),c.lines[a.currentIndex]=e.trustAsHtml(c.plainText[a.currentIndex])}else c.plainText[a.currentIndex]=t.slice(0,-1),c.lines[a.currentIndex]=e.trustAsHtml(c.plainText[a.currentIndex])}function y(n){c.plainText[a.currentIndex]=n,c.lines[a.currentIndex]=e.trustAsHtml(c.plainText[a.currentIndex])}function g(e){switch(e){case" ":return"&nbsp;";case'"':return"&quot;";case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;";case";":return"&#59;";default:return e}}function x(e){var n="command-"+e;s.hash()!==n?s.hash(n):u()}a.options={write_delay:10,init_text:[],terminal_name:"imtk@curveinth"},a.currentIndex=0,a.writePromise=n.resolve(),a.typerAviable=!1,a.command="",a.commandHistory=[""],a.commandHistoryPointer=0,c.plainText=[""],c.lines=[""],function(){var e=new Date,n=a.options.init_text.slice(0);n.push("Last login : "+e.toUTCString()+" on ttys001"),f(n)}(),r.bind("keydown",function(e){switch(e.keyCode){case 8:return a.typerAviable&&i(function(){h(),a.command=a.command.slice(0,-1)}),e.preventDefault(),!0;case 9:return a.typerAviable&&i(function(){}),e.preventDefault(),!0;case 13:return a.typerAviable&&i(function(){if(m(),a.command){var e=a.command.split(" ").filter(function(e){return e}),n=e.shift();a.commandHistory[a.commandHistory.length-1]=a.command,a.commandHistory.push(""),a.commandHistoryPointer=a.commandHistory.length-1,o.execute(n,e).then(function(e){f(e.messages)}),a.command=""}else d(l(),!0)}),e.preventDefault(),!0;case 38:return a.typerAviable&&a.commandHistoryPointer>0&&i(function(){a.commandHistoryPointer--,y(l()+a.commandHistory[a.commandHistoryPointer])}),e.preventDefault(),!0;case 40:return a.typerAviable&&(console.log(a.commandHistory),a.commandHistoryPointer<a.commandHistory.length-1&&i(function(){a.commandHistoryPointer++,y(l()+a.commandHistory[a.commandHistoryPointer])})),e.preventDefault(),!0;default:return!0}}),r.bind("keypress",function(e){a.typerAviable&&(i(function(){p(e.key),a.command+=e.key}),e.preventDefault())})}}}]);